#include <Arduino.h>
#include <WiFi.h>
#include <WebServer.h>
#include <WebSocketsServer.h>
#include <esp_wifi.h>
#include <esp_wifi_types.h>
#include <esp_bt.h>
#include <esp_bt_main.h>
#include <esp_bt_device.h>
#include <BLEDevice.h>
#include <BLEUtils.h>
#include <BLEScan.h>
#include <BLEAdvertisedDevice.h>
#include <ArduinoJson.h>
#include "SPIFFS.h"
#include <Update.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <freertos/semphr.h>
#include <esp_task_wdt.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>
#include <TFT_eSPI.h>
#include <Button2.h>
#include <PubSubClient.h>
#include <qrcode.h>
#include <HTTPClient.h>
#include <driver/adc.h>
#include <esp_adc_cal.h>
#include <map>

// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
// ğŸ•µï¸â€â™‚ï¸ Ù†Ø¸Ø§Ù… RTX-GHOST - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙŠØ²Ø§Øª
// â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

// ğŸŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
const char* AP_SSID = "RTX-GHOST-CONTROL";
const char* AP_PASSWORD = "ghost123456";

// ğŸ–¥ï¸ Ø®ÙˆØ§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
WebServer server(80);
WebSocketsServer webSocket(81);

// ğŸ“± Ø´Ø§Ø´Ø© TFT
TFT_eSPI tft = TFT_eSPI();
bool tftAvailable = false;

// ğŸ¤– Telegram Bot
const String BOT_TOKEN = "YOUR_BOT_TOKEN";
const String CHAT_ID = "YOUR_CHAT_ID";
WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

// ğŸ”— MQTT Client
WiFiClient mqttClient;
PubSubClient mqtt(mqttClient);
const char* mqttServer = "your-mqtt-broker.com";
const int mqttPort = 1883;
const char* mqttUser = "rtxghost";
const char* mqttPassword = "mqtt123";

// ğŸŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
const String GOOGLE_DRIVE_TOKEN = "your_google_drive_token";
const String DROPBOX_TOKEN = "your_dropbox_token";

// ğŸˆ² Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ§Øª
std::map<String, std::map<String, String>> translations = {
    {"ar", {
        {"title", "Ù†Ø¸Ø§Ù… RTX-GHOST"},
        {"scan", "Ù…Ø³Ø­ Ø§Ù„Ø´Ø¨ÙƒØ§Øª"},
        {"attack", "Ù‡Ø¬ÙˆÙ…"},
        {"defense", "Ø¯ÙØ§Ø¹"},
        {"settings", "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"},
        {"battery", "Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©"},
        {"temperature", "Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©"},
        {"connected", "Ù…ØªØµÙ„"},
        {"disconnected", "ØºÙŠØ± Ù…ØªØµÙ„"}
    }},
    {"en", {
        {"title", "RTX-GHOST System"},
        {"scan", "Scan Networks"},
        {"attack", "Attack"},
        {"defense", "Defense"},
        {"settings", "Settings"},
        {"battery", "Battery"},
        {"temperature", "Temperature"},
        {"connected", "Connected"},
        {"disconnected", "Disconnected"}
    }},
    {"fr", {
        {"title", "SystÃ¨me RTX-GHOST"},
        {"scan", "Scanner RÃ©seaux"},
        {"attack", "Attaque"},
        {"defense", "DÃ©fense"},
        {"settings", "ParamÃ¨tres"},
        {"battery", "Batterie"},
        {"temperature", "TempÃ©rature"},
        {"connected", "ConnectÃ©"},
        {"disconnected", "DÃ©connectÃ©"}
    }}
};

String currentLanguage = "ar";

// ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
String adminPassword = "admin123";
bool authEnabled = true;
String currentToken = "";

// ğŸ“Š Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
String eventLog = "";
bool systemActive = true;
bool stealthMode = false;
bool vpnEnabled = false;
bool torEnabled = false;

// ğŸ”‹ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
float batteryLevel = 0.0;
float temperature = 0.0;
esp_adc_cal_characteristics_t adc_chars;

// ğŸ¯ Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
String generateToken() {
    String token = "";
    for(int i = 0; i < 16; i++) {
        token += String(random(16), HEX);
    }
    return token;
}

String translate(String key) {
    return translations[currentLanguage].count(key) ? translations[currentLanguage][key] : key;
}

void updateSystemMetrics() {
    // Ù‚Ø±Ø§Ø¡Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© (Ù…Ø­Ø§ÙƒØ§Ø© - ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¯Ø§Ø¦Ø±Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©)
    batteryLevel = analogRead(34) / 4095.0 * 100.0;
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
    temperature = temperatureRead();
    
    addToLog("ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³: Ø¨Ø·Ø§Ø±ÙŠØ© " + String(batteryLevel) + "%, Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© " + String(temperature) + "C", "system");
}

// ğŸŒ Ø¥Ù†Ø´Ø§Ø¡ QR Code
void generateQRCode(String data) {
    if(!tftAvailable) return;
    
    // Ø¥Ù†Ø´Ø§Ø¡ QR Code
    QRCode qrcode;
    uint8_t qrcodeData[qrcode_getBufferSize(3)];
    qrcode_initText(&qrcode, qrcodeData, 3, 0, data.c_str());
    
    // Ø±Ø³Ù… QR Code Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    tft.fillScreen(TFT_BLACK);
    tft.setTextColor(TFT_WHITE, TFT_BLACK);
    tft.setTextSize(1);
    tft.setCursor(0, 0);
    tft.println(translate("title"));
    
    int scale = 2;
    for (uint8_t y = 0; y < qrcode.size; y++) {
        for (uint8_t x = 0; x < qrcode.size; x++) {
            if (qrcode_getModule(&qrcode, x, y)) {
                tft.fillRect(20 + x * scale, 30 + y * scale, scale, scale, TFT_WHITE);
            }
        }
    }
}

// ğŸ”— MQTT Callback
void mqttCallback(char* topic, byte* payload, unsigned int length) {
    String message = "";
    for (int i = 0; i < length; i++) {
        message += (char)payload[i];
    }
    
    addToLog("ğŸ“¡ Ø±Ø³Ø§Ù„Ø© MQTT: " + String(topic) + " - " + message, "mqtt");
    
    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¹Ø¨Ø± MQTT
    if (String(topic) == "rtxghost/control/scan") {
        startNetworkDiscovery();
    } else if (String(topic) == "rtxghost/control/attack") {
        // ØªÙ†ÙÙŠØ° Ù‡Ø¬ÙˆÙ… Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    } else if (String(topic) == "rtxghost/control/defense") {
        toggleDefenseMode();
    }
}

bool connectMQTT() {
    if (mqtt.connect("RTXGhostClient", mqttUser, mqttPassword)) {
        mqtt.subscribe("rtxghost/control/#");
        mqtt.publish("rtxghost/status", "online");
        addToLog("âœ… Ù…ØªØµÙ„ Ø¨Ù€ MQTT Broker", "mqtt");
        return true;
    }
    return false;
}

// â˜ï¸ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
bool uploadToGoogleDrive(String filename, String content) {
    if (GOOGLE_DRIVE_TOKEN == "your_google_drive_token") return false;
    
    HTTPClient http;
    http.begin("https://www.googleapis.com/upload/drive/v3/files?uploadType=media");
    http.addHeader("Authorization", "Bearer " + GOOGLE_DRIVE_TOKEN);
    http.addHeader("Content-Type", "application/octet-stream");
    
    int httpCode = http.POST(content);
    bool success = (httpCode == 200);
    
    if (success) {
        addToLog("âœ… ØªÙ… Ø±ÙØ¹ " + filename + " Ø¥Ù„Ù‰ Google Drive", "cloud");
    } else {
        addToLog("âŒ ÙØ´Ù„ Ø±ÙØ¹ " + filename + " Ø¥Ù„Ù‰ Google Drive", "cloud");
    }
    
    http.end();
    return success;
}

bool uploadToDropbox(String filename, String content) {
    if (DROPBOX_TOKEN == "your_dropbox_token") return false;
    
    HTTPClient http;
    http.begin("https://content.dropboxapi.com/2/files/upload");
    http.addHeader("Authorization", "Bearer " + DROPBOX_TOKEN);
    http.addHeader("Content-Type", "application/octet-stream");
    http.addHeader("Dropbox-API-Arg", "{\"path\": \"/" + filename + "\",\"mode\": \"overwrite\"}");
    
    int httpCode = http.POST(content);
    bool success = (httpCode == 200);
    
    if (success) {
        addToLog("âœ… ØªÙ… Ø±ÙØ¹ " + filename + " Ø¥Ù„Ù‰ Dropbox", "cloud");
    } else {
        addToLog("âŒ ÙØ´Ù„ Ø±ÙØ¹ " + filename + " Ø¥Ù„Ù‰ Dropbox", "cloud");
    }
    
    http.end();
    return success;
}

// ğŸ›¡ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ Ø¹Ø¨Ø± VPN/Tor
void enableStealthMode() {
    stealthMode = true;
    
    if (vpnEnabled) {
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§ØªØµØ§Ù„ VPN (ØªÙ†ÙÙŠØ° Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ­ØªØ§Ø¬ Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
        addToLog("ğŸ”’ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ Ø¹Ø¨Ø± VPN", "stealth");
    }
    
    if (torEnabled) {
        // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ø¨Ø± Tor (ØªÙ†ÙÙŠØ° Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØ­ØªØ§Ø¬ Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
        addToLog("ğŸ”’ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ Ø¹Ø¨Ø± Tor", "stealth");
    }
    
    // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† MAC Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    randomizeMACAddress();
    
    // ØªØ¹Ø·ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
    esp_bt_controller_disable();
}

// ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ø®ØªÙ„ÙØ©
String exportToCSV() {
    String csv = "SSID,BSSID,Channel,RSSI,Encryption,Clients\n";
    
    for (auto& net : discoveredNetworks) {
        csv += net.ssid + ",";
        csv += net.bssid + ",";
        csv += String(net.channel) + ",";
        csv += String(net.rssi) + ",";
        csv += net.encryption + ",";
        csv += String(net.clients) + "\n";
    }
    
    return csv;
}

String exportToJSON() {
    DynamicJsonDocument doc(4096);
    JsonArray networks = doc.to<JsonArray>();
    
    for (auto& net : discoveredNetworks) {
        JsonObject netObj = networks.createNestedObject();
        netObj["ssid"] = net.ssid;
        netObj["bssid"] = net.bssid;
        netObj["channel"] = net.channel;
        netObj["rssi"] = net.rssi;
        netObj["encryption"] = net.encryption;
        netObj["clients"] = net.clients;
    }
    
    String json;
    serializeJson(doc, json);
    return json;
}

String exportToExcelHTML() {
    String html = R"(<html>
<head>
<style>
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid black; padding: 8px; text-align: left; }
th { background-color: #f2f2f2; }
</style>
</head>
<body>
<table>
<tr>
<th>SSID</th><th>BSSID</th><th>Channel</th><th>RSSI</th><th>Encryption</th><th>Clients</th>
</tr>)";
    
    for (auto& net : discoveredNetworks) {
        html += "<tr>";
        html += "<td>" + net.ssid + "</td>";
        html += "<td>" + net.bssid + "</td>";
        html += "<td>" + String(net.channel) + "</td>";
        html += "<td>" + String(net.rssi) + "</td>";
        html += "<td>" + net.encryption + "</td>";
        html += "<td>" + String(net.clients) + "</td>";
        html += "</tr>";
    }
    
    html += "</table></body></html>";
    return html;
}

class RTXGhostUltimatePro {
private:
    TaskHandle_t metricsTaskHandle = NULL;
    TaskHandle_t mqttTaskHandle = NULL;

public:
    void begin() {
        Serial.begin(115200);
        
        // ØªÙ‡ÙŠØ¦Ø© SPIFFS
        if(!SPIFFS.begin(true)) {
            Serial.println("âŒ ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© SPIFFS");
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø´Ø§Ø´Ø© TFT
        if(initTFT()) {
            tftAvailable = true;
            updateTFTDisplay();
        }
        
        // ØªÙ‡ÙŠØ¦Ø© ADC Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©
        adc1_config_width(ADC_WIDTH_BIT_12);
        adc1_config_channel_atten(ADC1_CHANNEL_6, ADC_ATTEN_DB_11);
        esp_adc_cal_characterize(ADC_UNIT_1, ADC_ATTEN_DB_11, ADC_WIDTH_BIT_12, 1100, &adc_chars);
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ÙŠÙˆØªÙƒØ³
        wifiMutex = xSemaphoreCreateMutex();
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        initializeSystem();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù‚Ø·Ø© Ø§Ù„ÙˆØµÙˆÙ„
        createAccessPoint();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ MQTT
        setupMQTT();
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø®ÙˆØ§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
        setupWebServer();
        
        // Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        startServices();
        
        addToLog("ğŸš€ Ù†Ø¸Ø§Ù… RTX-GHOST Pro Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„", "success");
        sendTelegramMessage("ğŸš€ Ù†Ø¸Ø§Ù… RTX-GHOST Pro Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„");
    }

    void setupMQTT() {
        mqtt.setServer(mqttServer, mqttPort);
        mqtt.setCallback(mqttCallback);
        
        xTaskCreatePinnedToCore(
            [](void* param) {
                RTXGhostUltimatePro* system = (RTXGhostUltimatePro*)param;
                while(true) {
                    if (!system->mqtt.connected()) {
                        system->connectMQTT();
                    }
                    system->mqtt.loop();
                    vTaskDelay(1000 / portTICK_PERIOD_MS);
                }
            },
            "MQTTTask",
            4096,
            this,
            1,
            &mqttTaskHandle,
            1
        );
    }

    void setupWebServer() {
        // ğŸ” ØµÙØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚
        server.on("/login", HTTP_POST, [this]() {
            String password = server.arg("password");
            if(authenticateUser(password, "")) {
                currentToken = generateToken();
                server.send(200, "application/json", "{\"token\":\"" + currentToken + "\"}");
            } else {
                server.send(401, "application/json", "{\"error\":\"Invalid password\"}");
            }
        });

        // ğŸ“± Ø¥Ù†Ø´Ø§Ø¡ QR Code
        server.on("/qr", HTTP_GET, [this]() {
            String qrData = "WIFI:S:" + String(AP_SSID) + ";T:WPA;P:" + String(AP_PASSWORD) + ";;";
            generateQRCode(qrData);
            server.send(200, "text/plain", "QR Code generated on display");
        });

        server.on("/qr/connect", HTTP_GET, [this]() {
            String ip = WiFi.softAPIP().toString();
            String qrData = "http://" + ip;
            generateQRCode(qrData);
            server.send(200, "text/plain", "Connection QR generated");
        });

        // â˜ï¸ Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ
        server.on("/export/googledrive", HTTP_POST, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            String data = exportToJSON();
            if(uploadToGoogleDrive("rtxghost_networks.json", data)) {
                server.send(200, "application/json", "{\"status\":\"uploaded\"}");
            } else {
                server.send(500, "application/json", "{\"error\":\"upload_failed\"}");
            }
        });

        server.on("/export/dropbox", HTTP_POST, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            String data = exportToJSON();
            if(uploadToDropbox("rtxghost_networks.json", data)) {
                server.send(200, "application/json", "{\"status\":\"uploaded\"}");
            } else {
                server.send(500, "application/json", "{\"error\":\"upload_failed\"}");
            }
        });

        // ğŸ“Š Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØµØ¯ÙŠØ±
        server.on("/export/csv", HTTP_GET, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            String csv = exportToCSV();
            server.send(200, "text/csv", csv);
            server.sendHeader("Content-Disposition", "attachment; filename=networks.csv");
        });

        server.on("/export/json", HTTP_GET, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            String json = exportToJSON();
            server.send(200, "application/json", json);
        });

        server.on("/export/excel", HTTP_GET, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            String html = exportToExcelHTML();
            server.send(200, "text/html", html);
            server.sendHeader("Content-Disposition", "attachment; filename=networks.xls");
        });

        // ğŸ›¡ï¸ Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ
        server.on("/stealth/enable", HTTP_POST, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(401, "application/json", "{\"error\":\"Unauthorized\"}");
                return;
            }
            
            vpnEnabled = server.arg("vpn") == "true";
            torEnabled = server.arg("tor") == "true";
            
            enableStealthMode();
            server.send(200, "application/json", "{\"status\":\"stealth_enabled\"}");
        });

        // ğŸŒ Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„ØºØ©
        server.on("/language", HTTP_POST, [this]() {
            if(server.hasArg("lang")) {
                currentLanguage = server.arg("lang");
                server.send(200, "application/json", "{\"status\":\"language_changed\"}");
            }
        });

        // ğŸ“Š Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
        server.on("/metrics", HTTP_GET, [this]() {
            DynamicJsonDocument doc(512);
            doc["battery"] = batteryLevel;
            doc["temperature"] = temperature;
            doc["free_heap"] = ESP.getFreeHeap();
            doc["uptime"] = millis() / 1000;
            
            String response;
            serializeJson(doc, response);
            server.send(200, "application/json", response);
        });

        // ğŸ“± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        server.on("/", HTTP_GET, [this]() {
            if(!authenticateUser(server.arg("password"), server.arg("token"))) {
                server.send(200, "text/html", getLoginPage());
                return;
            }
            server.send(200, "text/html", getAdvancedMainPage());
        });

        server.begin();
    }

    String getAdvancedMainPage() {
        String page = R"raw(
<!DOCTYPE html>
<html dir="rtl" lang=")raw" + currentLanguage + R"raw(">
<head>
    <meta charset="UTF-8">
    <title>RTX-GHOST Ultimate Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0a; --card: #1a1a1a; }
        body { font-family: Arial; background: var(--bg); color: white; margin: 0; padding: 20px; }
        .header { text-align: center; padding: 20px 0; border-bottom: 3px solid var(--primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .btn { background: var(--primary); color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .metrics { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .metric-card { background: var(--card); padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ•µï¸â€â™‚ï¸ )raw" + translate("title") + R"raw(</h1>
        <div>
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
            </select>
        </div>
    </div>

    <div class="metrics">
        <div class="metric-card">
            <h3>ğŸ”‹ )raw" + translate("battery") + R"raw(</h3>
            <div id="batteryLevel">0%</div>
        </div>
        <div class="metric-card">
            <h3>ğŸŒ¡ï¸ )raw" + translate("temperature") + R"raw(</h3>
            <div id="temperature">0Â°C</div>
        </div>
        <div class="metric-card">
            <h3>ğŸ“¶ Ø§Ù„Ø´Ø¨ÙƒØ§Øª</h3>
            <div id="networkCount">0</div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <h3>ğŸ“± QR Codes</h3>
            <button class="btn" onclick="generateWifiQR()">QR Ø§ØªØµØ§Ù„ WiFi</button>
            <button class="btn" onclick="generateWebQR()">QR Ø§Ù„ÙˆÙŠØ¨</button>
        </div>
        
        <div class="card">
            <h3>â˜ï¸ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ</h3>
            <button class="btn" onclick="exportToGoogleDrive()">Google Drive</button>
            <button class="btn" onclick="exportToDropbox()">Dropbox</button>
        </div>
        
        <div class="card">
            <h3>ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <button class="btn" onclick="exportCSV()">CSV</button>
            <button class="btn" onclick="exportJSON()">JSON</button>
            <button class="btn" onclick="exportExcel()">Excel</button>
        </div>
        
        <div class="card">
            <h3>ğŸ›¡ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ</h3>
            <label><input type="checkbox" id="vpnCheck"> VPN</label>
            <label><input type="checkbox" id="torCheck"> Tor</label>
            <button class="btn" onclick="enableStealth()">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙÙŠ</button>
        </div>
        
        <div class="card">
            <h3>ğŸ”— MQTT Ø§Ù„ØªØ­ÙƒÙ…</h3>
            <div id="mqttStatus">)raw" + translate("disconnected") + R"raw(</div>
            <button class="btn" onclick="mqttScan()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ Ø¹Ø¨Ø± MQTT</button>
        </div>
        
        <div class="card">
            <h3>ğŸ¯ Ø§Ù„Ù‡Ø¬Ù…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
            <button class="btn" onclick="startAdvancedScan()">Ù…Ø³Ø­ Ù…ØªÙ‚Ø¯Ù…</button>
            <button class="btn" onclick="captureHandshakes()">Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù…ØµØ§ÙØ­Ø§Øª</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('authToken') || new URLSearchParams(window.location.search).get('token');
        
        function changeLanguage() {
            const lang = document.getElementById('languageSelect').value;
            fetch('/language?token=' + token + '&lang=' + lang, {method: 'POST'})
                .then(() => location.reload());
        }
        
        function generateWifiQR() {
            fetch('/qr?token=' + token);
        }
        
        function generateWebQR() {
            fetch('/qr/connect?token=' + token);
        }
        
        function exportToGoogleDrive() {
            fetch('/export/googledrive?token=' + token, {method: 'POST'});
        }
        
        function exportToDropbox() {
            fetch('/export/dropbox?token=' + token, {method: 'POST'});
        }
        
        function exportCSV() {
            window.open('/export/csv?token=' + token);
        }
        
        function exportJSON() {
            window.open('/export/json?token=' + token);
        }
        
        function exportExcel() {
            window.open('/export/excel?token=' + token);
        }
        
        function enableStealth() {
            const vpn = document.getElementById('vpnCheck').checked;
            const tor = document.getElementById('torCheck').checked;
            fetch('/stealth/enable?token=' + token + '&vpn=' + vpn + '&tor=' + tor, {method: 'POST'});
        }
        
        function updateMetrics() {
            fetch('/metrics?token=' + token)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('batteryLevel').textContent = data.battery.toFixed(1) + '%';
                    document.getElementById('temperature').textContent = data.temperature.toFixed(1) + 'Â°C';
                });
                
            fetch('/api/networks?token=' + token)
                .then(r => r.json())
                .then(networks => {
                    document.getElementById('networkCount').textContent = networks.length;
                });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        setInterval(updateMetrics, 5000);
        updateMetrics();
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('languageSelect').value = ')raw" + currentLanguage + R"raw(';
    </script>
</body>
</html>
        )raw";
        
        return page;
    }

    void startServices() {
        webSocket.begin();
        webSocket.onEvent([this](uint8_t num, WStype_t type, uint8_t * payload, size_t length) {
            this->webSocketEvent(num, type, payload, length);
        });
        
        // Ù…Ù‡Ù…Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
        xTaskCreatePinnedToCore(
            [](void* param) {
                RTXGhostUltimatePro* system = (RTXGhostUltimatePro*)param;
                while(true) {
                    system->updateSystemMetrics();
                    system->mqtt.publish("rtxghost/metrics/battery", String(system->batteryLevel).c_str());
                    system->mqtt.publish("rtxghost/metrics/temperature", String(system->temperature).c_str());
                    vTaskDelay(5000 / portTICK_PERIOD_MS);
                }
            },
            "MetricsTask",
            4096,
            this,
            1,
            &metricsTaskHandle,
            1
        );
        
        addToLog("ğŸŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù†Ø´Ø·Ø©", "system");
    }

    void updateSystemMetrics() {
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© ÙˆØ§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
        uint32_t adc_reading = adc1_get_raw(ADC1_CHANNEL_6);
        batteryLevel = (esp_adc_cal_raw_to_voltage(adc_reading, &adc_chars) / 1000.0) * 100.0 / 3.3;
        temperature = temperatureRead();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø´Ø©
        if(tftAvailable) {
            updateTFTDisplay();
        }
    }

    void updateTFTDisplay() {
        tft.fillScreen(TFT_BLACK);
        tft.setTextColor(TFT_GREEN, TFT_BLACK);
        tft.setTextSize(2);
        
        tft.setCursor(0, 0);
        tft.println("ğŸ•µï¸ RTX-GHOST Pro");
        tft.println("-----------");
        
        tft.setTextSize(1);
        tft.printf("Battery: %.1f%%\n", batteryLevel);
        tft.printf("Temp: %.1fC\n", temperature);
        tft.printf("Networks: %d\n", discoveredNetworks.size());
        tft.printf("Stealth: %s\n", stealthMode ? "ON" : "OFF");
        
        if(stealthMode) {
            tft.setTextColor(TFT_RED, TFT_BLACK);
            tft.println("STEALTH MODE");
        }
    }

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ...
};

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
RTXGhostUltimatePro rtx_system;

void setup() {
    esp_task_wdt_init(30, true);
    rtx_system.begin();
    esp_task_wdt_add(NULL);
}

void loop() {
    rtx_system.run();
    delay(10);
}
